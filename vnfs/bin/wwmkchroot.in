#!/bin/bash
#
# 
# Copyright (c) 2001-2003 Gregory M. Kurtzer
#
# Copyright (c) 2003-2011, The Regents of the University of California,
# through Lawrence Berkeley National Laboratory (subject to receipt of any
# required approvals from the U.S. Dept. of Energy).  All rights reserved.
#
# $Id: wwmkchroot 913 2012-04-19 00:33:31Z gmk $

prefix="@prefix@"
exec_prefix="@exec_prefix@"
libexecdir="@libexecdir@"

# add support for a more diverse context based help
print_help () {

    if [[ -z $HELPFILE ]]
    then
        usage ;
    else
        #### Loading help files
        if [ -d "$libexecdir/warewulf/wwmkchroot" ]; then
            pushd $libexecdir/warewulf/wwmkchroot >/dev/null
            if [ -f "$HELPFILE.hlp" ]; then
                . "$HELPFILE.hlp" ;

		# create function print_full_help inside new help files 
                ## context specific help
                print_full_help ;
            else
				echo "Review available help context and try your search again."
                echo "$0: Error: Can not find $libexecdir/warewulf/wwmkchroot/$helpfile.hlp"
                exit 1
            fi
            popd >/dev/null
        else
            echo "ERROR: Template directory ($libexecdir/warewulf/wwmkchroot) does not exist!"
            exit 1
        fi
    fi
}

usage() {
    echo "$0 [options] TEMPLATE_NAME PATH"
    echo
    echo "OPTIONS:"
    echo "    -d        Debug output"
    echo "    -h        Usage summary"
    echo
    echo
    echo "Context Help:"
    for i in $libexecdir/warewulf/wwmkchroot/*.hlp; do
        NAME=`basename $i | sed -e 's/\.hlp$//'`
        DESC=`grep '^#DESC: ' $i | sed -e 's/#DESC: //'`
        echo "    -h $(printf " %-20s %s\n" "$NAME" "$DESC")"
    done
    echo
    echo
    echo "TEMPLATE_NAME (select one of the following):"
    for i in $libexecdir/warewulf/wwmkchroot/*.tmpl; do
        NAME=`basename $i | sed -e 's/\.tmpl$//'`
        DESC=`grep '^#DESC: ' $i | sed -e 's/#DESC: //'`
        printf "   * %-20s %s\n" "$NAME" "$DESC"
    done
    echo
    echo "PATH:"
    echo "   This is the location where the VNFS will be created"
    echo
    echo "EXAMPLES:"
    echo
    echo " # wwmkchroot rhel-generic /var/chroots/rhel"
    echo
}


### Argument processing
while getopts "a:dhv" opt; do
    case $opt in
        d)
            VERBOSE=1
            set -x
        ;;
        v)
            VERBOSE=1
        ;;
        h)
			shift $((OPTIND-1))
			HELPFILE=$1
            print_help ;
            exit
        ;;
        a)
            var=$OPTARG
        ;;
    esac
done

shift $((OPTIND-1))

export VNFSTEMPLATE=$1
shift
export CHROOTDIR=$1
shift

if [ -z "$VNFSTEMPLATE" -o -z "$CHROOTDIR" ]; then
    usage
    exit 1
fi


#### Loading templates
if [ -d "$libexecdir/warewulf/wwmkchroot" ]; then
    pushd $libexecdir/warewulf/wwmkchroot >/dev/null
    test -n "$VERBOSE" && echo "Loading general template functions"
    if [ -f "functions" ]; then
        . "functions"
    else
        echo "$0: Error: Can not find $libexecdir/warewulf/wwmkchroot/functions"
        exit 1;
    fi

    test -n "$VERBOSE" && echo "Loading $VNFSTEMPLATE template"
    if [ -f "$VNFSTEMPLATE.tmpl" ]; then
        . "$VNFSTEMPLATE.tmpl"
    else
        echo "$0: Error: Can not find $libexecdir/warewulf/wwmkchroot/$VNFSTEMPLATE.tmpl"
        exit 1
    fi
    popd >/dev/null
else
    echo "ERROR: Template directory ($libexecdir/warewulf/wwmkchroot) does not exist!"
    exit 1
fi


#### Running template functions
test -n "$VERBOSE" && echo "Starting template functions"
for function in $FUNCTIONS; do
    test -n "$VERBOSE" && echo "Running: $function"
    $function || exit 1
done

# vim:filetype=sh:syntax=sh:expandtab:ts=4:sw=4:
